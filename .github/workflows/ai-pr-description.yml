name: "AI PR Description"

permissions:
  contents: write
  pull-requests: write
  
on:
  pull_request:
    types: [ opened, edited, synchronize ]

jobs:
    generate-pr-description:
        runs-on: ubuntu-latest

        steps:
          - name: Checkout repository
            uses: actions/checkout@v4

          - name: Update Issue number in PR body
            run: |
              PR_NUMBER=${{ github.event.pull_request.number }}
              BRANCH_NAME=${{ github.head_ref }}
              ISSUE_NUMBER=$(echo "$BRANCH_NAME" | grep -oE '[0-9]+$')
              PR_BODY=$(gh pr view $PR_NUMBER --json body -q '.body')

              UPDATED_BODY=$(echo "$PR_BODY" | sed "s/- 관련 이슈 번호:.*/- 관련 이슈 번호: #$ISSUE_NUMBER/")

              gh pr edit $PR_NUMBER --body "$UPDATED_BODY"
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          - name: Get diff of the PR
            id: diff
            run: |
              DIFF=$(gh pr diff ${{ github.event.pull_request.number }})
              echo "diff<<EOF" >> $GITHUB_OUTPUT
              echo "$DIFF" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          - name: Generate PR Description using AI
            id: ai
            run: |
              SAFE_DIFF=$(printf '%s' "${{ steps.diff.outputs.diff }}" | jq -Rs .)
              
              cat > payload.json <<EOF
              {
                "model": "gpt-4.1-mini",
                "messages": [
                  { "role": "system", "content": "너는 GitHub PR 요약 전문가야." },
                  { "role": "user", "content": "아래 diff를 기반으로 '요구 사항 및 구현 내용' 섹션에 들어갈 고품질 한국어 PR 설명을 작성해줘. 불필요한 문장은 제거하고 리뷰어에게 도움이 되는 핵심 내용만 작성해줘." },
                  { "role": "user", "content": $SAFE_DIFF }
                ]
              }
              EOF
              
              RESPONSE=$(curl https://api.openai.com/v1/chat/completions \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d @payload.json)
              
    
              CONTENT=$(echo $RESPONSE | jq -r ".choices[0].message.content")
    
              echo "content<<EOF" >> $GITHUB_OUTPUT
              echo "$CONTENT" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            env:
              OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

          - name: Update PR body
            run: |
              PR_NUMBER=${{ github.event.pull_request.number }}
              PR_BODY=$(gh pr view $PR_NUMBER --json body -q '.body')
              
              UPDATED_BODY=$(echo "$PR_BODY" | sed "/<!-- AI_SUMMARY_START -->/,/<!-- AI_SUMMARY_END -->/c\\
              <!-- AI_SUMMARY_START -->\
              ${{ steps.ai.outputs.content }}\
              <!-- AI_SUMMARY_END -->"
              )
              
              gh pr edit $PR_NUMBER --body "$UPDATED_BODY"
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              CONTENT: ${{ steps.ai.outputs.content }}
