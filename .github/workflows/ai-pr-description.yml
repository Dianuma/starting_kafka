name: "AI PR Description"

permissions:
  contents: write
  pull-requests: write
  
on:
  pull_request:
    types: [ opened, edited, synchronize ]

jobs:
    generate-pr-description:
        runs-on: ubuntu-latest

        steps:
          - name: Checkout repository
            uses: actions/checkout@v4

          - name: Update Issue number in PR body
            run: |
              PR_NUMBER=${{ github.event.pull_request.number }}
              BRANCH_NAME=${{ github.head_ref }}
              ISSUE_NUMBER=$(echo "$BRANCH_NAME" | grep -oE '[0-9]+$')
              PR_BODY=$(gh pr view $PR_NUMBER --json body -q '.body')

              UPDATED_BODY=$(echo "$PR_BODY" | sed "s/- 관련 이슈 번호:.*/- 관련 이슈 번호: #$ISSUE_NUMBER/")

              gh pr edit $PR_NUMBER --body "$UPDATED_BODY"
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          - name: Get diff of the PR
            id: diff
            run: |
              DIFF=$(gh pr diff ${{ github.event.pull_request.number }})
              echo "diff<<EOF" >> $GITHUB_OUTPUT
              echo "$DIFF" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          - name: Generate PR Description using AI
            id: ai
            shell: bash
            run: |
              DIFF=$(gh pr diff ${{ github.event.pull_request.number }} | base64 -w 0)
              
              PR_PROMPT="
              아래 base64 diff를 디코딩한 후, 변경 사항을 의미 단위별 주제로 분류하고 번호 매겨 작성하라. 각 번호(주요 주제) 아래 핵심 내용을 불릿으로 정리한 중첩 목록(nested list) 형태로 요약하라.
              
              출력 규칙:
              1) 전체 길이를 공백 포함 100~400자로 제한할 것.
              2) 주요 변경점을 최소 1개 최대 10개 이하의 주제로 자동 분류하고 각 주제를 번호 매긴 상위 목록으로 나타낼 것.
              3) 주제는 기능 단위·모듈 단위·개발 의도 단위로 자연스럽게 묶으며, 변경된 파일·코드 흐름·개선 목적을 중심으로 자동 분류할 것.
              4) 각 주제 아래 하위 bullet 목록을 사용하여 핵심 내용만 간결하게 정리할 것
              5) 각 주제의 하위 bullet 수와 상세 설명의 비중은 해당 주제의 변경 규모·중요도에 비례해 최대 300자 ( 기본 길이 400과 합하여 700자)까지 추가적으로 조절할 것.
              6) 변경점이 매우 적거나 중요도가 낮다고 판단되는 주제는 생성하지 말고 목록에서 제외할 것.
              7) 변경 사항을 기반으로 확실한 내용만 서술하고 중복·불필요·추측성 문장은 금지.
              8) 라인 단위 설명 금지.
              9) 이모티콘 사용 금지.
              
              base64 diff:
              "

              printf -v ESCAPED_PROMPT '%s' "$PR_PROMPT"

              jq -n \
              --arg prompt "$ESCAPED_PROMPT" \
              --arg diff "$DIFF" \
              '{
                model: "gpt-4.1-mini",
                messages: [
                  { role: "system", content: "너는 GitHub PR 요약 전문가야." },
                  { role: "user",   content: $prompt },
                  { role: "user",   content: $diff }
                ]
              }' > payload.json
              
              RESPONSE=$(curl https://api.openai.com/v1/chat/completions \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d @payload.json)

              echo "DISPLAY RESPONSE"
              echo "$RESPONSE"
              CONTENT=$(echo $RESPONSE | jq -r ".choices[0].message.content")
    
              echo "content<<EOF" >> $GITHUB_OUTPUT
              echo "$CONTENT" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

          - name: Update PR body
            run: |
              PR_NUMBER=${{ github.event.pull_request.number }}
              
              PR_BODY=$(gh pr view $PR_NUMBER --json body -q '.body')
              
              CLEAN_BODY=$(printf "%s" "$PR_BODY" | sed -E ':a;N;$!ba;s/<!-- AI-GENERATOR:START -->.*<!-- AI-GENERATOR:END -->//g')
              
              echo "$CLEAN_BODY" > pr_body.txt
              
              cat << 'EOF' > ai_summary.txt
              ${{ steps.ai.outputs.content }}
              EOF
              
              {
                cat pr_body.txt
                echo ""
                echo "<!-- AI-GENERATOR:START -->"
                echo "⚙️ AI 생성 요약"
                echo "---"
                cat ai_summary.txt
                echo "<!-- AI-GENERATOR:END -->"
              } > updated_body.txt
              
              # 4) 출력 확인
              echo "==== UPDATED_BODY BEGIN ===="
              cat updated_body.txt
              echo "==== UPDATED_BODY END ===="
              
              # 5) PR 내용 업데이트
              gh pr edit $PR_NUMBER --body "$(cat updated_body.txt)"
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              CONTENT: ${{ steps.ai.outputs.content }}
