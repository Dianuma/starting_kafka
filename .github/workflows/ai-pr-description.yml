name: "AI PR Description"

permissions:
  contents: write
  pull-requests: write
  
on:
  pull_request:
    types: [ opened, edited, synchronize ]

jobs:
    generate-pr-description:
        runs-on: ubuntu-latest

        steps:
          - name: Checkout repository
            uses: actions/checkout@v4

          - name: Update Issue number in PR body
            run: |
              PR_NUMBER=${{ github.event.pull_request.number }}
              BRANCH_NAME=${{ github.head_ref }}
              ISSUE_NUMBER=$(echo "$BRANCH_NAME" | grep -oE '[0-9]+$')
              PR_BODY=$(gh pr view $PR_NUMBER --json body -q '.body')

              UPDATED_BODY=$(echo "$PR_BODY" | sed "s/- 관련 이슈 번호:.*/- 관련 이슈 번호: #$ISSUE_NUMBER/")

              gh pr edit $PR_NUMBER --body "$UPDATED_BODY"
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          - name: Get diff of the PR
            id: diff
            run: |
              DIFF=$(gh pr diff ${{ github.event.pull_request.number }})
              echo "diff<<EOF" >> $GITHUB_OUTPUT
              echo "$DIFF" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          - name: Generate PR Description using AI
            id: ai
            shell: bash
            run: |
              DIFF=$(gh pr diff ${{ github.event.pull_request.number }} | base64 -w 0)
              cat > payload.json <<__PAYLOAD__
              {
                "model": "gpt-4.1-mini",
                "messages": [
                  { "role": "system", "content": "너는 GitHub PR 요약 전문가야." },
                  { "role": "user", "content": "아래 diff는 base64 로 인코딩된 내용이다. base64 decode 후, 해당 내용을 기반으로 '요구 사항 및 구현 내용' 섹션에 들어갈 고품질 한국어 PR 설명을 작성해줘. 불필요한 문장은 제거하고 리뷰어에게 도움이 되는 핵심 내용만 작성해줘." },
                  { "role": "user", "content": "$DIFF" }
                ]
              }
              __PAYLOAD__
              
              RESPONSE=$(curl https://api.openai.com/v1/chat/completions \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d @payload.json)

              echo "DISPLAY RESPONSE"
              echo "$RESPONSE"
              CONTENT=$(echo $RESPONSE | jq -r ".choices[0].message.content")
    
              echo "content<<EOF" >> $GITHUB_OUTPUT
              echo "$CONTENT" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

          - name: Update PR body
            run: |
              PR_NUMBER=${{ github.event.pull_request.number }}
              
              # 1) PR body 를 파일로 저장 (필수)
              gh pr view $PR_NUMBER --json body -q '.body' > pr_body.txt
              
              # 2) AI 결과를 안전하게 파일로 저장
              cat << 'EOF' > ai_summary.txt
              ${{ steps.ai.outputs.content }}
              EOF
              
              # 3) 안전한 교체 수행 (awk)
              awk \
                -v replacement="$(cat ai_summary.txt)" \
                '{
                   gsub(/<!-- AI_SUMMARY_START -->.*<!-- AI_SUMMARY_END -->/,
                        "<!-- AI_SUMMARY_START -->\n" replacement "\n<!-- AI_SUMMARY_END -->")
                   print
                 }' pr_body.txt > updated_body.txt
              
              # 4) 출력 확인
              echo "==== UPDATED_BODY BEGIN ===="
              cat updated_body.txt
              echo "==== UPDATED_BODY END ===="
              
              # 5) PR 내용 업데이트
              gh pr edit $PR_NUMBER --body "$(cat updated_body.txt)"
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              CONTENT: ${{ steps.ai.outputs.content }}
