name: "AI PR Description"

permissions:
  contents: write
  pull-requests: write
  
on:
  pull_request:
    types: [ opened, edited, synchronize ]

jobs:
    generate-pr-description:
        runs-on: ubuntu-latest

        steps:
          - name: Checkout repository
            uses: actions/checkout@v4

          - name: Update Issue number in PR body
            run: |
              PR_NUMBER=${{ github.event.pull_request.number }}
              BRANCH_NAME=${{ github.head_ref }}
              ISSUE_NUMBER=$(echo "$BRANCH_NAME" | grep -oE '[0-9]+$')
              PR_BODY=$(gh pr view $PR_NUMBER --json body -q '.body')

              UPDATED_BODY=$(echo "$PR_BODY" | sed "s/- 관련 이슈 번호:.*/- 관련 이슈 번호: #$ISSUE_NUMBER/")

              gh pr edit $PR_NUMBER --body "$UPDATED_BODY"
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          - name: Get diff of the PR
            id: diff
            run: |
              DIFF=$(gh pr diff ${{ github.event.pull_request.number }})
              echo "diff<<EOF" >> $GITHUB_OUTPUT
              echo "$DIFF" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          - name: Generate PR Description using AI
            id: ai
            shell: bash
            run: |
              DIFF=$(gh pr diff ${{ github.event.pull_request.number }} | base64 -w 0)
              cat > payload.json <<__PAYLOAD__
              {
                "model": "gpt-4.1-mini",
                "messages": [
                  { "role": "system", "content": "너는 GitHub PR 요약 전문가야." },
                  { "role": "user",   "content": "아래 diff는 base64로 인코딩된 코드 변경 내용이다. base64를 decode한 뒤, 해당 diff를 분석하여 '요구 사항 및 구현 내용' 섹션에 들어갈 한국어 PR 설명을 작성해줘.\n\nPR 설명 생성 기준은 다음과 같다:\n1) diff의 변경된 양과 중요도에 비례해 설명 길이를 조절할 것 (큰 변경은 더 상세히, 작은 변경은 간단하게)\n2) 주요 변경 사항, 변경 사유, 영향 범위, 리뷰어가 확인해야 할 사항을 중심으로 작성할 것\n3) 기술 구현 상세는 필요한 경우에만 간결하게 서술할 것. 라인 단위 설명은 하지 말 것\n4) 불필요한 문장, 중복 설명, 추측성 내용은 포함하지 말 것\n5) 이모티콘(emoji)은 절대 사용하지 말 것\n\n위 기준을 충족하는 자연스럽고 실용적인 PR 설명을 작성해줘.\n\n아래는 base64 diff 내용이다:\n"},
                  { "role": "user", "content": "$DIFF" }
                ]
              }
              __PAYLOAD__
              
              RESPONSE=$(curl https://api.openai.com/v1/chat/completions \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d @payload.json)

              echo "DISPLAY RESPONSE"
              echo "$RESPONSE"
              CONTENT=$(echo $RESPONSE | jq -r ".choices[0].message.content")
    
              echo "content<<EOF" >> $GITHUB_OUTPUT
              echo "$CONTENT" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

          - name: Update PR body
            run: |
              PR_NUMBER=${{ github.event.pull_request.number }}
              
              # 1) PR body 를 파일로 저장 (필수)
              gh pr view $PR_NUMBER --json body -q '.body' > pr_body.txt
              
              # 2) AI 결과를 안전하게 파일로 저장
              cat << 'EOF' > ai_summary.txt
              ${{ steps.ai.outputs.content }}
              EOF
              
              {
                cat pr_body.txt
                echo ""
                echo "⚙️ AI 생성 요약"
                echo "---"
                echo "<!-- AI_SUMMARY_START -->"
                cat ai_summary.txt
                echo "<!-- AI_SUMMARY_END -->"
              } > updated_body.txt
              
              # 4) 출력 확인
              echo "==== UPDATED_BODY BEGIN ===="
              cat updated_body.txt
              echo "==== UPDATED_BODY END ===="
              
              # 5) PR 내용 업데이트
              gh pr edit $PR_NUMBER --body "$(cat updated_body.txt)"
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              CONTENT: ${{ steps.ai.outputs.content }}
